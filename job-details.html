<script>
document.addEventListener("DOMContentLoaded", () => {
  loadJobDetails();
});

// Google Sheets endpoint (already used in jobs page)
const GOOGLE_SHEET_JSON_URL =
  "https://sheets.googleapis.com/v4/spreadsheets/1EssTu-5IUbgIZTnAA3vA0U4PJKgiBnMlRMi6IlbKq_M/values/Sawariya_Jobs!A1:L1000?key=AIzaSyBmPzDMUIuYnLNL9Eqhmb0P6KxZj_3Lcoc";

async function loadJobDetails() {
  const params = new URLSearchParams(window.location.search);
  const jobId = params.get("id");

  if (!jobId) {
    window.location.href = "jobs.html";
    return;
  }

  try {
    const response = await fetch(GOOGLE_SHEET_JSON_URL);
    if (!response.ok) throw new Error("Failed to fetch jobs");

    const data = await response.json();
    if (!data.values || data.values.length < 2) {
      throw new Error("No jobs found");
    }

    const rows = data.values.slice(1);

    const jobs = rows.map(row => ({
      id: row[0],
      title: row[1],
      location: row[2],
      salary: row[3],
      type: row[4],
      description: row[5],
      requirements: row[6] ? row[6].split("|") : [],
      responsibilities: row[7] ? row[7].split("|") : [],
      benefits: row[8] ? row[8].split("|") : [],
      company: row[9],
      posted: row[10],
      active: String(row[11]).trim().toUpperCase() === "TRUE"
    }));

    const job = jobs.find(j => j.id === jobId && j.active);

    if (!job) {
      window.location.href = "jobs.html";
      return;
    }

    displayJobDetails(job);

  } catch (error) {
    console.error("Job detail error:", error);
    window.location.href = "jobs.html";
  }
}

function displayJobDetails(job) {
  document.title = `${job.title} - Sawariya HR Solutions`;

  document.getElementById("jobHeader").innerHTML = `
    <h1 style="font-size:2.5rem;margin-bottom:.5rem">${job.title}</h1>
    <p>${job.location} • ${job.salary} • ${job.type}</p>
    <p style="color:var(--text-gray)">Posted on ${formatDate(job.posted)} • Job ID: ${job.id}</p>
  `;

  document.getElementById("jobMain").innerHTML = `
    <div class="job-detail-section">
      <h3>About the Role</h3>
      <p>${job.description}</p>
    </div>

    <div class="job-detail-section">
      <h3>Responsibilities</h3>
      <ul>${job.responsibilities.map(r => `<li>${r}</li>`).join("")}</ul>
    </div>

    <div class="job-detail-section">
      <h3>Requirements</h3>
      <ul>${job.requirements.map(r => `<li>${r}</li>`).join("")}</ul>
    </div>

    ${job.benefits.length ? `
    <div class="job-detail-section">
      <h3>Benefits</h3>
      <ul>${job.benefits.map(b => `<li>${b}</li>`).join("")}</ul>
    </div>` : ""}
  `;

  document.getElementById("jobSidebar").innerHTML = `
    <h3>Apply for this Job</h3>
    <p><strong>Company:</strong> ${job.company}</p>
    <p><strong>Location:</strong> ${job.location}</p>

    <a href="apply.html?job=${job.id}" class="btn btn-primary" style="width:100%;margin-bottom:1rem">
      Apply Online
    </a>

    <a href="https://wa.me/917772074181?text=I%20want%20to%20apply%20for%20${encodeURIComponent(job.title)}%20(Job%20ID:%20${job.id})"
       class="btn btn-secondary"
       target="_blank"
       style="width:100%">
      Apply via WhatsApp
    </a>
  `;
}

function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString("en-IN", {
    year: "numeric",
    month: "long",
    day: "numeric"
  });
}
</script>
