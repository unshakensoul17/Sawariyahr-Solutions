<script>
/* ===============================
   PAGE LOAD (SAFE)
================================ */
document.addEventListener("DOMContentLoaded", () => {
  // ‚úÖ Run ONLY on jobs.html
  if (document.getElementById("allJobs")) {
    loadAllJobs("", "", "");
  }
});

/* ===============================
   APPLY FILTERS
================================ */
function applyFilters() {
  const location = document.getElementById("filterLocation")?.value.toLowerCase() || "";
  const type = document.getElementById("filterType")?.value.toLowerCase() || "";
  const search = document.getElementById("filterSearch")?.value.toLowerCase() || "";

  loadAllJobs(location, type, search);
}

/* ===============================
   LOAD JOBS FROM GOOGLE SHEETS
================================ */
async function loadAllJobs(locationFilter = "", typeFilter = "", searchFilter = "") {
  const container = document.getElementById("allJobs");
  const countEl = document.getElementById("jobsCount");
  const noJobsMsg = document.getElementById("noJobsMessage");

  // üîí HARD GUARD
  if (!container) return;

  container.innerHTML = "<div class='loading'>Loading jobs...</div>";
  if (countEl) countEl.textContent = "Loading jobs...";
  if (noJobsMsg) noJobsMsg.style.display = "none";

  try {
    const response = await fetch(GOOGLE_SHEET_JSON_URL);
    if (!response.ok) throw new Error("Failed to load jobs");

    const data = await response.json();
    if (!data.values || data.values.length < 2) {
      throw new Error("No jobs found");
    }

    const rows = data.values.slice(1);

    let jobs = rows.map(row => ({
      id: row[0] || "",
      title: row[1] || "",
      location: row[2] || "",
      salary: row[3] || "",
      type: row[4] || "",
      description: row[5] || "",
      active: String(row[11]).trim().toUpperCase() === "TRUE"
    }));

    // ‚úÖ Only active jobs
    jobs = jobs.filter(job => job.active);

    // ‚úÖ Normalize filters (IMPORTANT)
    jobs = jobs.filter(job => {
      const jobLocation = job.location.toLowerCase();
      const jobType = job.type.toLowerCase().replace("-", " ");

      const locFilter = locationFilter.replace("-", " ");
      const typeFilterNorm = typeFilter.replace("-", " ");

      if (locFilter && !jobLocation.includes(locFilter)) return false;
      if (typeFilterNorm && !jobType.includes(typeFilterNorm)) return false;

      if (
        searchFilter &&
        !job.title.toLowerCase().includes(searchFilter) &&
        !job.description.toLowerCase().includes(searchFilter)
      ) return false;

      return true;
    });

    displayJobs(jobs);

  } catch (error) {
    console.error("Job loading error:", error);
    container.innerHTML = "";
    if (countEl) countEl.textContent = "Error loading jobs";
    if (noJobsMsg) noJobsMsg.style.display = "block";
  }
}

/* ===============================
   DISPLAY JOBS
================================ */
function displayJobs(jobs) {
  const container = document.getElementById("allJobs");
  const countEl = document.getElementById("jobsCount");
  const noJobsMsg = document.getElementById("noJobsMessage");

  if (!container) return;

  if (!jobs.length) {
    container.innerHTML = "";
    if (countEl) countEl.textContent = "No jobs found";
    if (noJobsMsg) noJobsMsg.style.display = "block";
    return;
  }

  if (noJobsMsg) noJobsMsg.style.display = "none";
  if (countEl) countEl.textContent = `Showing ${jobs.length} job${jobs.length > 1 ? "s" : ""}`;

  container.innerHTML = jobs.map(job => `
    <div class="job-card">
      <div class="job-header">
        <h3 class="job-title">${job.title}</h3>
        <span class="job-type-badge">${job.type}</span>
      </div>

      <div class="job-meta">
        <div class="job-meta-item">üìç ${job.location}</div>
        <div class="job-meta-item">üí∞ ${job.salary}</div>
      </div>

      <p class="job-description">${job.description}</p>

      <div class="job-actions">
        <a href="/job/${job.id}" class="btn btn-outline btn-small">View Details</a>
        <a href="/apply/${job.id}" class="btn btn-primary btn-small">Apply Now</a>
      </div>
    </div>
  `).join("");
}
</script>
